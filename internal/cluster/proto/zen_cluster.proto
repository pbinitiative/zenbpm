edition = "2023";
package cluster;

import "zencommand.proto";

option go_package = "github.com/pbinitiative/zenbpm/internal/cluster/proto";

// GRPC API exposed through private GRPC endpoint
service ZenService {
  // Notify notifies this node that a remote node is ready
  // for bootstrapping.
  rpc Notify(NotifyRequest) returns (NotifyResponse);
  // Join joins a remote node to the cluster.
  rpc Join(JoinRequest) returns (JoinResponse);

  // requests directed at zen cluster leader to perform changes to ClusterState

  // called by a partition leader when new node joins the cluster
  rpc AddPartitionNode(AddPartitionNodeRequest)
      returns (AddPartitionNodeResponse);
  // called by a partition leader when node becomes unreachable
  rpc ShutdownPartitionNode(ShutdownPartitionNodeRequest)
      returns (ShutdownPartitionNodeResponse);
  // called by a partition leader when he becomes a leader of partition cluster
  rpc PartitionNodeLeaderChange(PartitionNodeLeaderChangeRequest)
      returns (PartitionNodeLeaderChangeResponse);
  // called by a partition leader when member node has to be reaped due to reap
  // settings
  rpc RemovePartitionNode(RemovePartitionNodeRequest)
      returns (RemovePartitionNodeResponse);
  // called by a partition leader when member node becomes responsive after
  // being marked as shut down
  rpc ResumePartitionNode(ResumePartitionNodeRequest)
      returns (ResumePartitionNodeResponse);

  // cluster management endpoints

  rpc ClusterBackup(ClusterBackupRequest) returns (ClusterBackupResponse);
  rpc ClusterRestore(ClusterRestoreRequest) returns (ClusterRestoreResponse);
  rpc ConfigurationUpdate(ConfigurationUpdateRequest)
      returns (ConfigurationUpdateResponse);
  rpc AssignPartition(AssignPartitionRequest) returns (AssignPartitionResponse);
  rpc UnassignPartition(UnassignPartitionRequest)
      returns (UnassignPartitionResponse);
  rpc PartitionBackup(PartitionBackupRequest) returns (PartitionBackupResponse);
  rpc PartitionRestore(PartitionRestoreRequest)
      returns (PartitionRestoreResponse);
  rpc StartCpuProfiler(CpuProfilerRequest) returns (CpuProfilerStartResult);
  rpc StopCpuProfiler(CpuProfilerRequest) returns (CpuProfilerStopResult);

  rpc NodeCommand(zencommand.Command) returns (NodeCommandResponse);

  // engine endpoints
  // Deploys definition into partitions that receiving node is leader of
  rpc EvaluateDecision(EvaluateDecisionRequest) returns (EvaluatedDRDResult);
  rpc DeployDecisionDefinition(DeployDecisionDefinitionRequest) returns (DeployDecisionDefinitionResponse);
  rpc DeployProcessDefinition(DeployProcessDefinitionRequest) returns (DeployProcessDefinitionResponse);
  rpc ActivateJob(ActivateJobRequest) returns (stream ActivateJobResponse);
  // PublishMessage requests a message publish on the engine running on a leader node of partition
  rpc PublishMessage(PublishMessageRequest) returns (PublishMessageResponse);
  rpc SetMessageSubscriptionPointer(SetMessageSubscriptionPointerRequest) returns (SetMessageSubscriptionPointerResponse);
  rpc FindActiveMessage(FindActiveMessageRequest) returns (FindActiveMessageResponse);
  rpc CreateInstance(CreateInstanceRequest) returns (CreateInstanceResponse);
  rpc GetProcessInstances(GetProcessInstancesRequest) returns (GetProcessInstancesResponse);
  rpc GetJobs(GetJobsRequest) returns (GetJobsResponse);
  rpc GetProcessInstance(GetProcessInstanceRequest) returns (GetProcessInstanceResponse);
  rpc GetProcessInstanceJobs(GetProcessInstanceJobsRequest) returns (GetProcessInstanceJobsResponse);
  rpc GetFlowElementHistory(GetFlowElementHistoryRequest) returns (GetFlowElementHistoryResponse);
  rpc GetIncidents(GetIncidentsRequest) returns (GetIncidentsResponse);
  rpc ResolveIncident(ResolveIncidentRequest) returns (ResolveIncidentResponse);
  // Subscribes client to receive jobs of type
  rpc SubscribeJob(stream SubscribeJobRequest) returns (stream SubscribeJobResponse);
  rpc CompleteJob(CompleteJobRequest) returns (CompleteJobResponse);
  rpc FailJob(FailJobRequest) returns (FailJobResponse);
  // Used by client to let server know that the job needs to be reassigned to another node
  rpc ReassignJob(ReassignJobRequest) returns (ReassignJobResponse);
}

// TODO: do we want to keep custom error struct or use the default error handling?
message ErrorResult {
  uint32 code = 1;
  string message = 2;
}

message NotifyRequest {
  string id = 1;
  string address = 2;
}

message NotifyResponse {
  ErrorResult error = 1;
}

message JoinRequest {
  string id = 1;
  string address = 2;
  bool voter = 3;
}

message JoinResponse {
  ErrorResult error = 1;
  string leader = 2;
}

message AddPartitionNodeRequest {
  string id = 1;
  string address = 2;
  bool voter = 3;
  uint32 partition = 4;
}

message AddPartitionNodeResponse {
  ErrorResult error = 1;
}

message ShutdownPartitionNodeRequest {
  string id = 1;
  uint32 partition = 2;
}

message ShutdownPartitionNodeResponse {
  ErrorResult error = 1;
}

message PartitionNodeLeaderChangeRequest {
  string id = 1;
  uint32 partition = 2;
}

message PartitionNodeLeaderChangeResponse {
  ErrorResult error = 1;
}

message RemovePartitionNodeRequest {
  string id = 1;
  uint32 partition = 2;
}

message RemovePartitionNodeResponse {
  ErrorResult error = 1;
}

message ResumePartitionNodeRequest {
  string id = 1;
  uint32 partition = 2;
}

message ResumePartitionNodeResponse {
  ErrorResult error = 1;
}

// INTERNAL ENGINE API START

message EvaluateDecisionRequest {
  string bindingType = 1;
  string decisionId = 2;
  string versionTag = 3;
  bytes variables = 4;
}

message EvaluatedDRDResult {
  ErrorResult error = 1;
  repeated EvaluatedDecisionResult evaluatedDecisions = 2;
  bytes DecisionOutput = 3;
}

message EvaluatedDecisionResult {
  string decisionId = 1;
  string decisionName = 2;
  string decisionType = 3;
  int64 decisionDefinitionVersion = 4;
  int64 decisionDefinitionKey = 5;
  string decisionDefinitionId = 6;
  repeated EvaluatedRule matchedRules = 7 ;
  bytes decisionOutput = 8 ;
  repeated EvaluatedInput evaluatedInputs = 9;
}

message EvaluatedRule {
  string ruleId = 1;
  int32  ruleIndex = 2;
  repeated EvaluatedOutput  evaluatedOutputs = 3;
}

message EvaluatedOutput {
  string outputId = 1;
  string outputName = 2;
  bytes outputValue = 3;
}

message EvaluatedInput {
  string inputId = 1;
  string inputName = 2;
  string inputExpression = 3;
  bytes inputValue = 4;
}

message DecisionDefinition {
  int64 key = 1;
  int32 version = 2;
  string decision_definition_id = 3;
  bytes definition = 4;
}

message Decision {
  int64 key = 1;
  int32 version = 2;
  string decision_id = 3;
  string version_tag = 4;
  string decision_definition_id = 5;
  string decision_definition_key = 6;
}

message ProcessDefinition {
  int64 key = 1;
  int32 version = 2;
  string process_id = 3;
  bytes definition = 4;
}

message ProcessInstance {
  int64 key = 1;
  string process_id = 2;
  bytes variables = 3;
  int64 state = 4;
  int64 createdAt = 5;
  int64 definition_key = 6;
}

message Job {
  int64 key = 1;
  int64 element_instance_key = 2;
  string element_id = 3;
  int64 process_instance_key = 4;
  string type = 5;
  int64 state = 6;
  int64 created_at = 7;
  bytes variables = 8;
}

message FlowElement {
  int64 key = 1;
  string element_id = 2;
  int64 process_instance_key = 3;
  int64 created_at = 4;
}

message Incident {
  int64 key = 1;
  int64 element_instance_key = 2;
  string element_id = 3;
  int64 process_instance_key = 4;
  string message = 5;
  int64 created_at = 6;
  int64 resolved_at = 7;
  int64 execution_token = 8;
}

message DeployDecisionDefinitionRequest {
  int64 key = 1;
  bytes data = 2;
}

message DeployDecisionDefinitionResponse {
  ErrorResult error = 1;
}

message DeployProcessDefinitionRequest {
  int64 key = 1;
  bytes data = 2;
}

message DeployProcessDefinitionResponse {
  ErrorResult error = 1;
}

message CompleteJobRequest {
  int64 key = 1;
  bytes variables = 2; // []byte of json variables 
  string client_id = 3;
}


message CompleteJobResponse {
  ErrorResult error = 1;
}
message FailJobRequest {
  int64 key = 1;
  string message = 2;
  string client_id = 3;
  string error_code = 4;
  bytes variables = 5;
}

message FailJobResponse {
  ErrorResult error = 1;
}

message ActivateJobRequest {
  string job_type = 1;
}

message ActivateJobResponse {
  ErrorResult error = 1;
  InternalJob job = 2;
}

message InternalJob {
  int64 key = 1;
  int64 instance_key = 2;
  bytes variables = 3;
  string type = 4;
  int64 state = 5;
  string element_id = 6;
  int64 created_at = 7;
}

message SetMessageSubscriptionPointerRequest {
  int64 state = 1;
  int64 createdAt = 2;
  string name = 3;
  string correlationKey = 4;
  int64 messageSubscriptionKey = 5;
  int64 executionTokenKey = 6;
  uint32 partitionId = 7;
}

message SetMessageSubscriptionPointerResponse {
  ErrorResult error = 1;
}

message FindActiveMessageRequest {
  string name = 1;
  string correlationKey = 2;
  int64 executionTokenKey = 3;
}

message FindActiveMessageResponse {
  ErrorResult error = 1;
  int64 key = 2;
  string elementId = 3;
  int64 processDefinitionKey = 4;
  int64 processInstanceKey = 5;
  string name = 6;
  int64 state = 7;
  string correlationKey = 8;
  int64 executionToken = 9;
}

message PublishMessageRequest {
  int64 key = 1;
  bytes variables = 2;
}

message PublishMessageResponse {
  ErrorResult error = 1;
}

message CreateInstanceRequest {
  oneof start_by{
    int64 definition_key = 1;
    string latest_process_id = 2;
  }
  bytes variables = 3;
}

message CreateInstanceResponse {
  ErrorResult error = 1;
  ProcessInstance process = 2;
}

message GetProcessInstancesRequest {
  int32 page = 1;
  int32 size = 2;
  repeated uint32 partitions = 3;
  int64 definition_key = 4;
}

message PartitionedProcessInstances {
  uint32 partition_id = 1;
  repeated ProcessInstance instances = 2;
}

message GetProcessInstancesResponse {
  ErrorResult error = 1;
  repeated PartitionedProcessInstances partitions = 2;
}

message GetProcessInstanceRequest {
  int64 process_instance_key = 1;
}

message GetProcessInstanceResponse {
  ErrorResult error = 1;
  ProcessInstance processes = 2;
}

message GetProcessInstanceJobsRequest {
  int64 process_instance_key = 1;
}

message GetProcessInstanceJobsResponse {
  ErrorResult error = 1;
  repeated Job jobs = 2;
}

message GetFlowElementHistoryRequest {
  int64 process_instance_key = 1;
}

message GetFlowElementHistoryResponse {
  ErrorResult error = 1;
  repeated FlowElement flow = 2;
}

message GetIncidentsRequest {
  int64 process_instance_key = 1;
}

message GetIncidentsResponse {
  ErrorResult error = 1;
  repeated Incident incidents = 2;
}

message GetJobsRequest {
  int32 page = 1;
  int32 size = 2;
  repeated uint32 partitions = 3;
  string jobType = 4;
  int64 state = 5;
}

message PartitionedJobs {
  uint32 partition_id = 1;
  repeated Job jobs = 2;
}

message GetJobsResponse {
  ErrorResult error = 1;
  repeated PartitionedJobs partitions = 2;
}

message ResolveIncidentRequest {
  int64 incident_key = 1;
}

message ResolveIncidentResponse {
  ErrorResult error = 1;
}

message SubscribeJobRequest {
  string job_type = 1;
  enum Type {
    TYPE_UNKNOWN = 0;
    TYPE_SUBSCRIBE = 1; // subscribe client to provided job_type
    TYPE_UNSUBSCRIBE = 2; // unsubscribe client from provided job_type
    TYPE_UNSUBSCRIBE_ALL = 3; // client is no longer available and we should clean up
  }
  Type type = 2;
  string client_id = 3;
}

message SubscribeJobResponse {
  string job_type = 1;
  string client_id = 2;
  InternalJob job = 3;
}

message ReassignJobRequest {
  int64 key = 1;
}

message ReassignJobResponse {
  ErrorResult error = 1;
}

message CpuProfilerRequest {}

message CpuProfilerStartResult {
  ErrorResult error = 1;
}

message CpuProfilerStopResult {
  ErrorResult error = 1;
  bytes pprof = 2;
}

// INTERNAL ENGINE API END

// TODO: implement missing messages when needed by cluster communication
message PartitionRestoreRequest {}
message PartitionRestoreResponse {}
message PartitionBackupRequest {}
message PartitionBackupResponse {}
message UnassignPartitionRequest {}
message UnassignPartitionResponse {}
message AssignPartitionRequest {}
message AssignPartitionResponse {}
message ConfigurationUpdateRequest {}
message ConfigurationUpdateResponse {}
message ClusterRestoreRequest {}
message ClusterRestoreResponse {}
message ClusterBackupRequest {}
message ClusterBackupResponse {}

message NodeCommandResponse {
  ErrorResult error = 1;
  zencommand.Command.Type type = 2;
  oneof response {
    ClusterNodeChangeResponse node_change = 3;
    ClusterNodePartitionChangeResponse node_partition_change = 4;
  }
}

message ClusterNodeChangeResponse {}
message ClusterNodePartitionChangeResponse {}
